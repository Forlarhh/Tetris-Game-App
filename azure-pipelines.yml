trigger: none

pool:
  name: Forlarhh2
  vmImage: 'windows-latest'

variables:
  VAULT_ADDR: $(http://127.0.0.1:8200)
  VAULT_ROLE_ID: $(e575f2e8-ce7e-6a04-af30-dded0341665f)
  VAULT_SECRET_ID: $(ae04d9a7-063a-6568-986d-dd3786faa8d8)

steps:
  # Install Vault CLI
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        Write-Output "Installing Vault CLI..."
        Invoke-WebRequest -Uri https://releases.hashicorp.com/vault/1.10.0/vault_1.10.0_windows_amd64.zip -OutFile vault.zip
        Expand-Archive -Path vault.zip -DestinationPath "$env:ProgramFiles\vault"
        $env:Path += ";$env:ProgramFiles\vault"
        vault --version

  # Authenticate to Vault and retrieve secrets
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        # Define Vault variables
        $vaultAddr = "$(http://127.0.0.1:8200)"
        $roleId = "$(e575f2e8-ce7e-6a04-af30-dded0341665f)"
        $secretId = "$(ae04d9a7-063a-6568-986d-dd3786faa8d8)"

        # Authenticate with Vault using AppRole
        $vaultToken = vault write -field=token auth/approle/login role_id=$roleId secret_id=$secretId

        # Fetch secrets
        $clientId = vault kv get -field=value secret/data/azure/client_id
        $clientSecret = vault kv get -field=value secret/data/azure/client_secret

        # Set environment variables for subsequent steps
        Write-Output "##vso[task.setvariable variable=ARM_CLIENT_ID]$clientId"
        Write-Output "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$clientSecret"
    displayName: 'Retrieve Secrets from Vault'

  # Additional deployment steps
  - script: |
      # Use the secrets stored as environment variables in the pipeline
      echo "Client ID: $env:ARM_CLIENT_ID"
      echo "Client Secret is fetched and used securely"
    displayName: 'Use Secrets in Deployment'
